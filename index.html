<!doctype html>
<html>
<script>
var HEAP = new ArrayBuffer(32*1024*1024);
var I4 = new Int32Array(HEAP);
var tempptr = 0;
var imageptr = (8*8)<<2;
</script>
<script src="filter.js"></script>
<script src="dct.js"></script>
<script src="dering.js"></script>
<body>
<script>
function rgb2ycgco(inbuf, outbuf, pixels) {
  var y, cg, co;
  var i = 0;
  while (i < pixels) {
    y = (inbuf[i*4] + 2 * inbuf[i*4+1] + inbuf[i*4+2])*4;
    cg = (-inbuf[i*4] + 2 * inbuf[i*4+1] - inbuf[i*4+2])*4;
    co = (inbuf[i*4] - inbuf[i*4+2])*8;
    outbuf[i] = y;
    outbuf[i+1*pixels] = cg;
    outbuf[i+2*pixels] = co;
    i = i+1;
  }
}
function ycgco2rgb(inbuf, outbuf, pixels) {
  var r, g, b, t;
  var i = 0;
  while (i < pixels) {
    t = inbuf[i] - inbuf[i+pixels];
    r = t + inbuf[i+2*pixels];
    g = inbuf[i] + inbuf[i+pixels];
    b = t - inbuf[i+2*pixels];
    outbuf[i*4] = r >> 4;
    outbuf[i*4+1] = g >> 4;
    outbuf[i*4+2] = b >> 4;
    i = i+1;
  }
}
var quant_table = [
[16, 16, 18, 21, 24, 28, 32, 36],
[16, 17, 20, 21, 24, 27, 31, 35],
[18, 20, 24, 25, 27, 31, 33, 38],
[21, 21, 25, 28, 30, 34, 37, 42],
[24, 24, 27, 30, 34, 38, 43, 49],
[28, 27, 31, 34, 38, 44, 50, 58],
[32, 31, 33, 37, 43, 50, 58, 68],
[36, 35, 38, 42, 49, 58, 68, 78]];
function quantize(w, h, scale) {
  w = w | 0;
  h = h | 0;
  scale = scale | 0;
  var i = 0, j = 0, p = imageptr, v = 0, k = 0, l = 0, q = 0;
  for (i = 0; i+7 < h; i += 8) {
    for (j = 0; j+7 < w; j += 8) {
      dct.od_bin_idct8x8((p + j) << 2, w, (p + j) << 2, w, tempptr)
    }
    for (j = 0; j+7 < w; j += 8) {
      for (k = 0; k < 8; k++) {
	for (l = k ? 0 : 1; l < 8; l++) {
          var q = (quant_table[k][l] * scale) >> 4;
          v = I4[p + j + k*w+l];
          v = Math.round(v / q) * q;
          I4[p + j + k*w+l] = v;
        }
      }
    }
    for (j = 0; j+7 < w; j += 8) {
      dct.od_bin_fdct8x8((p + j) << 2, w, (p + j) << 2, w, tempptr)
    }
    p += 8 * w;
  }
}
function dering_image(w, h, threshold) {
  w = w | 0;
  h = h | 0;
  threshold = threshold | 0;
  var i = 0, j = 0;
  var dering_tables = imageptr + ((w * h * 3) << 2) | 0;
  var od_dering = dering.od_dering;
  dering.init_tables(dering_tables);
  for (j = 8; j + 10 < h; j = j+8|0) {
    for (i = 8; i + 10 < w; i = i+8|0) {
      od_dering(imageptr +((j*w+i)<<2), w, imageptr +((j*w+i)<<2), w, 0, threshold, dering_tables);
    }
   }
}
var config = {
  scale: 31,
  strength: 2.0,
  lapping: true
};
var imagedata;
var imagebuffer;
function init_image() {
  var canvas = document.getElementById('canvas');
  var srcimage = document.getElementById('srcimage');
  var w = srcimage.width;
  var h = srcimage.height;
  canvas.width = w;
  canvas.height = h;
  var ctx = canvas.getContext('2d');
  ctx.drawImage(srcimage, 0, 0, w, h, 0, 0, w, h);
  window.imagedata = ctx.getImageData(0, 0, w, h);
  window.imagebuffer = window.I4.subarray(imageptr>>2, (imageptr>>2) + w * h * 3);
  update_image();
}
function update_image() {
  if (!imagedata) return;
  var w = imagedata.width;
  var h = imagedata.height;
  rgb2ycgco(imagedata.data, imagebuffer, w*h);
  var ts = new Date();
  if (config.lapping) {
    filter.lapvert(imageptr, w, h);
    filter.laphorz(imageptr, w, h, tempptr);
  }
  quantize(w, h, config.scale);
  if (config.lapping) {
    filter.unlaphorz(imageptr, w, h, tempptr);
    filter.unlapvert(imageptr, w, h);
  }
  if (config.strength > 0) {
    dering_image(w, h, (config.scale*78>>4)*config.strength);
  }
  console.log(new Date() - ts);
  var canvas = document.getElementById('canvas');
  var ctx = canvas.getContext('2d');
  var imageout = ctx.getImageData(0, 0, w, h)
  ycgco2rgb(imagebuffer, imageout.data, w*h);
  ctx.putImageData(imageout, 0, 0);
}
function loadUserImage(event) {
  var file = event.target.files[0];
  var reader  = new FileReader();
  reader.addEventListener("load", function () {
    document.getElementById('srcimage').src = reader.result;
  }, false);
  if (file) reader.readAsDataURL(file);
}
</script>
<img style="display:none;" id="srcimage" src="barrbrain.jpg" onload="init_image();"/>
<div>
  <label for="lapping">Quantization level</label>
  <input id="scale" type="range" min="8" max="300" step="1" oninput="config.scale=this.value|0;update_image();"/>
</div><div>
  <label for="lapping">4-point lapping filter (deblocking)</label>
  <input id="lapping" checked type="checkbox" onchange="config.lapping=!!(this.checked);update_image();"/>
</div><div>
  <label for="lapping">Deringing filter strength</label>
  <input id="strength" type="range" min="0.0" max="4" step="0.1" oninput="config.strength=this.value;update_image();"/>
</div><div>
  <label for="userImage">Load your own image (not uploaded)</label>
  <input id="userImage" type="file" onchange="loadUserImage(event);" />
</div>
<canvas id='canvas' width=1 height=1></canvas>
</body>
