<!doctype html>
<html>
<script>
var HEAP = new ArrayBuffer(16*1024*1024);
var I4 = new Int32Array(HEAP);
var tempptr = 0;
var imageptr = (8*8)<<2;
</script>
<script src="filter.js"></script>
<script src="dct.js"></script>
<script src="dering.js"></script>
<body>
<script>
function rgb2ycbco(inbuf, outbuf, pixels) {
  var y, cg, co;
  var i = 0;
  while (i < pixels) {
    y = (inbuf[i*4] + 2 * inbuf[i*4+1] + inbuf[i*4+2])*4;
    cg = (-inbuf[i*4] + 2 * inbuf[i*4+1] - inbuf[i*4+2])*4;
    co = (inbuf[i*4] - inbuf[i*4+2])*8;
    outbuf[i] = y;
    outbuf[i+1*pixels] = cg;
    outbuf[i+2*pixels] = co;
    i = i+1;
  }
}
function ycbco2rgb(inbuf, outbuf, pixels) {
  var r, g, b, t;
  var i = 0;
  while (i < pixels) {
    t = inbuf[i] - inbuf[i+pixels];
    r = t + inbuf[i+2*pixels];
    g = inbuf[i] + inbuf[i+pixels];
    b = t - inbuf[i+2*pixels];
    outbuf[i*4] = r >> 4;
    outbuf[i*4+1] = g >> 4;
    outbuf[i*4+2] = b >> 4;
    i = i+1;
  }
}
function quantize(w, h) {
  w = w | 0;
  h = h | 0;
  var i = 0, j = 0, p = imageptr, v = 0;
  for (i = 0; i < h; i += 8) {
    for (j = 0; j < w; j += 8) {
      dct.od_bin_idct8x8((p + j) << 2, w, (p + j) << 2, w, tempptr) 
    }
    for (j = 0; j < w * 8; j++) {
      v = I4[p + j];
      v = v >> 6;
      v = v << 6;
      I4[p + j] = v;
    }
    for (j = 0; j < w; j += 8) {
      dct.od_bin_fdct8x8((p + j) << 2, w, (p + j) << 2, w, tempptr) 
    }
    p += 8 * w;
  }
}
function dering_image(w, h) {
  var i = 0, j = 0;
  var dering_tables = imageptr + ((w * h * 3) << 2) | 0;
  var od_dering = dering.od_dering;
  dering.init_tables(dering_tables);
  for (j = 8; j + 8 < h; j = j+8|0) {
    for (i = 8; i + 8 < w; i = i+8|0) {
      od_dering(imageptr +j*w+i|0, w, imageptr +j*w+i|0, w, 0, 64, dering_tables);
    }
   }
}
function foo() {
  var canvas = document.getElementById('canvas');
  var srcimage = document.getElementById('srcimage');
  var w = srcimage.width;
  var h = srcimage.height;
  canvas.width = w;
  canvas.height = h;
  var ctx = canvas.getContext('2d');
  ctx.drawImage(srcimage, 0, 0, w, h, 0, 0, w, h);
  var image = ctx.getImageData(0, 0, w, h);
  var imagebuffer = window.I4.subarray(imageptr, w * h * 3);
  rgb2ycbco(image.data, imagebuffer, w*h);
  var ts = new Date();
  filter.lapvert(imageptr, w, h);
  filter.laphorz(imageptr, w, h, tempptr);
  console.log(new Date() - ts);
  ycbco2rgb(imagebuffer, image.data, w*h);
  ctx.putImageData(image, 0, 0);
  canvas = document.getElementById('canvas2');
  canvas.width = w;
  canvas.height = h;
  ctx = canvas.getContext('2d');
  ts = new Date();
  quantize(w, h);
  console.log(new Date() - ts);
  ycbco2rgb(imagebuffer, image.data, w*h);
  ctx.putImageData(image, 0, 0);
  ts = new Date();
  filter.unlaphorz(imageptr, w, h, tempptr);
  filter.unlapvert(imageptr, w, h);
  console.log(new Date() - ts);
  ycbco2rgb(imagebuffer, image.data, w*h);
  canvas = document.getElementById('canvas3');
  canvas.width = w;
  canvas.height = h;
  ctx = canvas.getContext('2d');
  ctx.putImageData(image, 0, 0);
  ts = new Date();
  dering_image(w, h);
  console.log(new Date() - ts);
  ycbco2rgb(imagebuffer, image.data, w*h);
  canvas = document.getElementById('canvas4');
  canvas.width = w;
  canvas.height = h;
  ctx = canvas.getContext('2d');
  ctx.putImageData(image, 0, 0);
}
</script>
<img id="srcimage" src="Clovisfest.jpg" onload="foo();"/>
<canvas id='canvas' width=1 height=1></canvas>
<canvas id='canvas2' width=1 height=1></canvas>
<canvas id='canvas3' width=1 height=1></canvas>
<canvas id='canvas4' width=1 height=1></canvas>
</body>
